📄 Diffapp Ver1.2 開発仕様書

対象：スマホアプリ（iOS / Android）
開発環境：Flutter
利用者層：小学生〜中学生
運用形態：完全無料・広告なし・オフライン動作

⸻

1. 基本情報

項目	内容
アプリ名	Diffapp（ディフアップ）
カテゴリ	教育 / ゲーム / 知育
目的	2枚の画像からAIが自動で間違いを検出し、子供にわかりやすく表示
実行環境	Android 9以降 / iOS 14以降
開発基盤	Flutter（Dart）＋プラットフォーム依存部分はネイティブ呼び出し
SDK管理	fvm（Flutter 3.22.0 をプロジェクトで固定）
ライセンス制約	オープンソースライブラリのみ使用可


⸻

2. 機能仕様

2.1 トップ画面
	•	ロゴ＋キャッチコピー
		- キャッチコピー文言（暫定）: AIがちがいをみつけるよ
	•	画像選択／撮影ボタン（左・右）
	•	「けんさをはじめる」ボタン
	•	設定アイコン（検出設定へ）

2.2 画像入力
	•	カメラ撮影（前後切替）
	•	ギャラリー選択（jpg/png）
	•	最大解像度：4000×3000px（内部で自動リサイズ）
		- 対応拡張子: jpg/jpeg/png（大文字小文字不問）
		- 超過時は縦横比を保持して 4000×3000 以内に縮小
	•	権限: Androidは CAMERA / READ_MEDIA_IMAGES（9〜12は READ_EXTERNAL_STORAGE）、iOSはカメラ/フォトライブラリアクセス文言を設定
	•	権限拒否時はSnackBarで「設定をひらく」導線を表示

2.3 比較範囲指定
	•	左画像を拡大表示
	•	指ドラッグで矩形選択（リサイズ可）
	•	選択範囲は右画像にも同座標で適用

2.4 画像前処理

処理	技術	詳細
傾き補正	OpenCV ORB/SIFT	特徴点マッチング＋ホモグラフィ変換
サイズ統一	OpenCV	幅1280px基準に縮小
トリミング	OpenCV	指定矩形領域で切り出し
色調整（任意）	OpenCV/Dart	自動コントラスト補正（Dartで簡易線形ストレッチを実装済み）

2.5 検出設定
	•	チェックボックス：色 / 形 / 場所 / 大きさ / 文字
	•	精度スライダー：3〜5段階
	•	初期設定：全ON、普通精度

2.6 検出処理

処理	技術	詳細
差分抽出	SSIM	ピクセルベースでスコアマップ生成
AIモデル	TensorFlow Lite（CNN）	形・文字認識補強
最大検出数	20件	上位スコア順に制限
補足	前処理	SSIMスコアマップを正規化→二値化→連結成分解析で矩形候補抽出（純Dart実装）

2.7 結果表示
	•	左右画像を並列表示
	•	赤枠ハイライト＋アニメーション（中央にポヨン演出）
	•	効果音（ON/OFF可）
		- 現状: 設定でON/OFF切替可。検出開始/再比較で効果音を再生
	•	「スクショをとろう！」案内
	•	再比較ボタン（選択範囲リセット＋案内SnackBar）

⸻

3. 非機能要件
	•	オフライン実行：通信不要
	•	パフォーマンス：処理5秒以内（1280px画像想定）
	•	ストレージ：一時ファイルはセッション終了時に削除
	•	セキュリティ：画像は外部送信禁止
	•	拡張性：Flutterで共通UIロジック、AI処理はプラットフォームごとに最適化可

⸻

4. アーキテクチャ設計
	•	フロント層：Flutter UI
	•	処理層：Dart → FFI経由でC++（OpenCV / TFLite）呼び出し
		- 現状: FFI土台を用意し、Dart実装にフォールバック（`ffi/image_ops.dart`, `FfiCnnDetector`）
		- C++サンプル関数: グレースケール変換 `to_grayscale_u8` を追加（Android NDK/CMake 設定済み。iOSは今後対応）
	•	データ層：端末内キャッシュ（メモリor一時ディレクトリ）
	•	依存関係管理：Flutter pub + CMake連携

アプリ構造イメージ：

Flutter (UI)
 └─ Application Layer (Dart)
     ├─ Image IO Service
     ├─ Preprocess Service (OpenCV FFI)
     ├─ Detection Service (TFLite)
     └─ Result Presenter


⸻

5. データハンドリング
	•	入力画像：一時ディレクトリに保存、処理後即削除
	•	中間結果：メモリ保持のみ（キャッシュ書き込み禁止）
	•	ログ：クラッシュログのみ（端末内、外部送信なし）
	•	永続保存：ユーザー操作でスクショ保存のみ

⸻

6. エラーハンドリング

ケース	表示／対応
入力画像なし	アラート「がぞうを えらんでね」
備考	ホーム画面の開始ボタン押下時にSnackBarで表示
解像度超過	自動リサイズ、警告なし
AIモデル読み込み失敗	「けんさに しっぱいしました。もういちどためしてね」
検出ゼロ件	「ちがいは みつかりませんでした」表示
タイムアウト（5秒超）	中断して再試行案内
内部例外	エラーログ記録、ユーザーには一般的メッセージ


⸻

7. テスト計画

単体テスト
	•	画像入力（カメラ/ギャラリー）
	•	矩形選択UI
	•	OpenCV補正処理
	•	TFLiteモデル推論（モックデータ使用）

結合テスト
	•	前処理〜差分抽出〜UI表示のパイプライン
	•	各設定（色/形/文字ON/OFF）の挙動確認

UI/UXテスト
	•	子供ユーザビリティテスト（直感操作確認）
	•	誤タップ対応（ボタンサイズ・ガイド）

パフォーマンステスト
	•	1280px画像2枚で5秒以内に完了
	•	メモリリーク監視

回帰テスト
	•	既存バージョンとの比較（機能退行なし）

補足（実装済みの自動テスト例）
	•	矩形スケーリング／NMS／入出力バリデーション（Dart単体）
	•	比較画面UIの同座標適用ボタン挙動（ウィジェットテスト）
	•	解像度超過時の自動リサイズ表示（ウィジェットテスト）
	•	モデル読込失敗時のエラーメッセージ表示（ウィジェットテスト）
	•	タイムアウト時の再試行案内メッセージ表示（ウィジェットテスト）
	•	内部例外の一般メッセージ表示＋ローカルログ記録（ウィジェットテスト）
	•	検出ゼロ件メッセージ表示（ウィジェットテスト）
	•	Dart/Flutter バージョン互換チェック（`test/sdk_compat_test.dart`）

⸻

8. 除外機能（Ver1.2）
	•	結果保存（共有／ダウンロード）
	•	SNS連携
	•	Web版提供

⸻

9. 今後の拡張余地
	•	オンデバイス強化学習（ユーザー補正フィードバック）
	•	結果保存（保護者ロック付き）
	•	マルチデバイス連携（将来のWeb版統合）

補足（UI）
	•	設定画面に「OSS ライセンス」リンクを追加（Materialの showLicensePage を使用して一覧表示）
