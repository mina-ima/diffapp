# Known Issues and Plan (2025-09-18)

## 現状の課題

1. 検査結果画面で画像が表示されないことがある

- 症状: 「検査結果」画面で1枚表示にしているが、画像が見えない（プレースホルダのまま）。
- 原因: 結果画面でのクロップ表示の Transform 順序が不正で、平行移動と拡大の適用順が逆だった。
  - 誤: `scale(s) → translate(-crop)`
  - 正: `translate(-crop) → scale(s)`
- 対処: `result_page.dart` を修正済み（translate → scale の順へ）。
- 注意: サンプルA/B/Cはダミー（bytes/path なし）なので結果画面では画像ではなくプレースホルダ表示になる。ギャラリー等、実画像で確認すること。

2. 検出数が多すぎ・見た目の枠数と一致しない

- 症状: SnackBar/表示上の「検出数: 20」だが、結果画面では 20 個見えない。
- 原因: 検出数は「全体（64x64空間）」での件数。一方、結果画面は「範囲指定ビューポート内」だけを表示するため、
  ビューポート外の枠は見えない。
- 暫定対処: 結果画面に「検出数: N（表示中: M）」と表示し、矛盾を可視化。M はビューポートと交差する枠数。

## 改善計画（Next）

1. 検出過剰の抑制（感度・最小面積・後処理）

- しきい値の調整: Settings.precision をより影響大に（例: 0.90 → 0.93〜0.97）
- 最小面積フィルタ: connected components の `minArea` を導入（例: >= 4〜9 px）
- 形状フィルタ: 幅/高さの最小値、アスペクト比の範囲を制限
- NMSの強化: IoU 閾値の調整（例: 0.3 → 0.2）やスコアの再定義

2. 表示整合性の強化

- 範囲指定がある場合は、検出もその範囲に限定するオプション（局所検出モード）
- 枠に番号ラベルを表示し、表示中件数と一致を取りやすくする
- 端にかかる枠のクリッピング（現在はPositionedでクリップされるが境界描画の見栄え調整）

3. 検証とテスト

- Flutter ウィジェットテスト: 左画像のみ、範囲指定ビューポート上で枠が正しく重なるかの検証を追加強化
- パフォーマンス: 1280px入力での処理5秒内を維持（既存テストに準拠）

## 実施済みの主な変更

- `lib/screens/result_page.dart`: 結果表示を左画像のみへ統一。範囲指定がある場合はそのビューポートを再現。
  Transform 順序を `translate(-crop) → scale(s)` に修正。上部に「検出数: N（表示中: M）」を表示。
- `lib/screens/compare_page.dart`: ResultPage に検出結果・表示寸法・元画像・範囲指定を受け渡し。
- `test/result_overlay_display_test.dart`: 左画像のみのオーバーレイ検出を前提に更新。
- `prompt_spec.md`: 仕様へ反映（単一画像＋範囲指定ビューポート）。

## 手動確認のTips

- ダミー画像（サンプルA/B/C）は bytes/path を持たないため、結果画面で画像が出ません。ギャラリーから実画像を選択してください。
- エミュレータでの再起動手順: `adb -s <emulator-id> reboot` → `sys.boot_completed=1` まで待機 → `pnpm android`。
