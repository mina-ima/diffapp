# 検査パイプライン計画

目的: 2枚の入力画像から「ちがい」を高速・高精度に抽出し、端末内で完結（オフライン）する検査処理を段階的に実装する。

## 方針

- 入力をまず幅 1280 に正規化（リサイズ）し、以降の処理を固定解像度で揃える。
- ピクセルベースの差分抽出は SSIM を採用し、テクスチャ差分のロバスト性を確保。
- SSIM スコアマップから閾値（しきい値）処理→二値化→連結成分（ラベリング）で矩形候補を抽出。
- 候補矩形に対して NMS（重複除去）を行い、重なりを整理。
- 形や文字などの誤検出抑制は TensorFlow Lite（TFLite）で軽量分類・補強（将来段階）。
- パフォーマンス: 1280 幅で 5秒以内 を目標（Ver1.2 基準）。

## 処理ステップ

1. 前処理（正規化/リサイズ）
   - 入力寸法を 4000x3000 にクランプ
   - 幅 1280 にスケーリング（縦横比維持）
2. 差分抽出（SSIM）
   - 1280幅の左右画像から SSIM スコアマップを生成（0..1）
   - 1-SSIM を差分強度として扱う
3. マスク生成（閾値→二値化）
   - 適応/固定いずれかのしきい値で二値化
   - モルフォロジーのオプション（開閉）でノイズ除去
4. 領域抽出（連結成分）
   - 連結成分ラベリング→外接矩形群を得る
   - 最小サイズ/アスペクト比でフィルタ
5. 候補整理（NMS）
   - IoU に基づく重複除去
   - 上位 N 件に制限
6. タイル分割フォールバック（追加検出）
   - 解析範囲を 20×20=400 タイルに分割し、各タイルの上位分位（例: 上位20%）の平均スコアを指標化
   - タイル指標を二値化→タイル空間で連結成分抽出→ピクセル矩形に復元
   - 既存検出と重ならない上位10クラスターを追加検出として採用（位置ズレ/傾き残りにも頑健）
7. 追加判定（TFLite, 将来）
   - 色/形/文字など特徴別の軽量分類で偽陽性を抑制

## I/O 仕様（中間表現）

- Input: Uint8List or RGBA/BGRA 画像, もしくはファイルパス
- Normalized: 幅 1280 （高さは比率）
- ScoreMap: Float32Array（0..1）
- Mask: Uint8（0/1）
- Regions: {x,y,w,h, score}

## パフォーマンス設計

- メモリ: 中間バッファを極力再利用
- 並列: SSIM のブロック計算を並列化（将来）
- 端末差: ネイティブ（FFI/OpenCV）へ段階的にオフロード

## テスト戦略

- 単体: 1280幅での寸法計算・SSIM スコア特性・二値化・連結成分・NMS の数値検証
- 端末: 代表デバイスで 5秒以内を計測
- 回帰: 極端比率・微小領域・高ノイズ画像のケースを固定

## Milestones / マイルストーン

- Phase 1: SSIM→二値化→連結成分→NMS（Dart純実装）
- Phase 2: パフォーマンス改善（SIMD/タイル化/メモリ再利用）
- Phase 3: FFI 経由で SSIM/連結成分をネイティブ化（OpenCV）
- Phase 4: TFLite 導入で誤検出抑制（軽量モデル）
- Phase 5: 端末チューニング（しきい値・NMS パラメータのデバイス最適化）

## 既存仕様との整合

- けんさせってい（設定）からの精度値は しきい値/NMS/最大件数 に反映
- 結果画面の赤枠ハイライトは Regions に基づいて描画
- 「ちがいは みつかりませんでした」は Regions=0 件で表示
