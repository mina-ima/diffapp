## 低メモリ端末での安定性確認 計画と簡易検証

### 目的

- 低メモリ条件でもアプリがクラッシュ（OOM）せず、一定の応答性を保つことを確認する。

### 対象端末

- Android: 2GB/3GB RAM 相当の低〜中位端末
- iOS: iPhone 8 / SE / 古い iPad 世代 等

### 制約条件

- 画像は 1280px 正規化を前提（内部処理の最大サイズを一定に）
- オフライン処理（通信なし）
- 一時ファイルはセッション終了時に削除（ストレージ継続増加を防止）
- キャッシュは上限管理（LRU）または逐次破棄でピークメモリを抑制

### 手順（想定）

1. 起動→トップ→左右画像選択→比較→結果→再比較を 3 周以上繰り返す
2. 設定: すべて ON、精度スライダー「高」も試す（負荷増）
3. 画像種類: 模様/単色/高コントラスト/文字含み の複数パターン
4. アプリがバックグラウンド→フォアグラウンド復帰を数回挟む（リソース再取得の安定性）
5. 5 秒タイムアウトが適切に働くか確認（長処理時の UI 停滞を回避）

### 計測項目

- メモリ使用量（ピーク/平均）と増加傾向（リーク兆候）
- フリーズ/クラッシュ（OOM）有無、例外ログ
- 1 比較あたりの完了時間（目標 5 秒以内）
- 一時ファイル残存の有無（セッション終了で削除されているか）

### 回復

- メモリ不足時は GC 誘発（画像バッファの解放）→ 処理再試行
- タイムアウト発生時はガイド表示しリトライ導線（UI スタックを塞がない）
- 例外は一般メッセージ＋ローカルログのみ（画像は送信しない）

### CI簡易検証（ヒント）

- Node/ホスト側での疑似的制限:
  - `ulimit -v` 等でプロセス仮想メモリ上限を下げ、簡単な E2E を実行（注: 端末実機の代替であり参考指標）
- Android:
  - `adb shell` でバックグラウンド・フォアグラウンド切り替え (`am start`/`am force-stop`) を組み合わせる
  - 開発者向けオプション「アクティビティを保持しない」を ON にしてリソース再確保の安定性を手動確認
- iOS:
  - Xcode の Debug > Simulate Memory Warning でメモリ警告を発生させ、例外/クラッシュの有無を確認

### 実装ポイント（既存仕様との対応）

- 1280px 正規化・NMS・上位 20 件制限により計算量を抑制
- 一時ファイル削除: セッション終了時にクリア
- フォールバック（FFI未接続時は Dart 実装）で安定動作を担保
- SSIM/CNN の処理が 5 秒以内で終わる前提のタイムアウトとガイド
